@model LabERP.Models.ViewModels.FinanceManagementViewModel

@{
    ViewData["Title"] = "財務管理";
}

<!-- 添加安全檢查 -->
@if (Model == null)
{
    <div class="alert alert-danger">
        <h4>錯誤</h4>
        <p>無法載入財務管理資料，請稍後再試。</p>
        <a href="@Url.Action("Dashboard", "User")" class="btn btn-secondary">返回儀表板</a>
    </div>
}
else
{
    <div class="container-fluid">
        <h2>@Model.LaboratoryName - 財務管理</h2>

        <!-- 財務概覽 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h4>總收入</h4>
                        <h2>$@Model.TotalIncome.ToString("N0")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h4>總支出</h4>
                        <h2>$@Model.TotalExpense.ToString("N0")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h4>餘額</h4>
                        <h2>$@Model.Balance.ToString("N0")</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        @if (User.IsInRole("Professor") && User.FindFirst("UserID").Value == Model.Creator.UserID)
        {
            <div class="row mb-4">
                <div class="col-12">
                <a asp-controller="Finance" asp-action="AddIncome" asp-route-labID="@Model.LaboratoryId" class="btn btn-success">
                    <i class="fas fa-plus"></i> 新增收入
                </a>
                <a asp-controller="Finance" asp-action="SalaryManagement" asp-route-labID="@Model.LaboratoryId" class="btn btn-warning">
                    <i class="fas fa-users"></i> 薪資管理
                </a>
                <a asp-controller="Finance" asp-action="BankAccountSettings" asp-route-labID="@Model.LaboratoryId" class="btn btn-info">
                    <i class="fas fa-university"></i> 銀行帳戶設定
                </a>
            </div>
        </div>
        }

        <!-- 最近記錄 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>最近交易記錄</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.RecentRecords?.Any() == true)
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>日期</th>
                                            <th>類型</th>
                                            <th>金額</th>
                                            <th>描述</th>
                                            <th>分類</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var record in Model.RecentRecords)
                                        {
                                            <tr>
                                                <td>@record.RecordDate.ToString("yyyy-MM-dd")</td>
                                                <td>
                                                    <span class="badge @(record.Type == "Income" ? "bg-success" : "bg-danger")">
                                                        @(record.Type == "Income" ? "收入" : "支出")
                                                    </span>
                                                </td>
                                                <td>$@record.Amount.ToString("N0")</td>
                                                <td>@record.Description</td>
                                                <td>@record.Category</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">尚無交易記錄</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <a asp-controller="Laboratory" asp-action="Details" asp-route-id="@Model.LaboratoryId">實驗室</a>
        </div>
    </div>
}